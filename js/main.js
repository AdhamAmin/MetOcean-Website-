
// TRANSLATIONS - FULL COVERAGE
const translations = {
    en: {
        //Nav & Footer
        brand: "Metocean",
        home: "Home",
        services: "Services",
        courses: "Courses",
        about: "About",
        contact: "Contact",
        portal: "Get Started",
        footerDesc: "Global leaders in oceanographic consulting. Over 25 years of enabling safe offshore operations through precision engineering and data.",
        quickLinks: "Quick Links",
        contactInfo: "Contact Info",
        rights: "© 2025 Metocean Consulting Group. All rights reserved.",
        createdBy: "Created by <a href='https://adhamamin.github.io/My-Portflio/' target='_blank' style='color: var(--primary); text-decoration: none;'>Adham Amin</a>",
        privacy: "Privacy Policy",
        address: "100 Ocean Way, Suite 500<br>Maritime City, MC 12345",

        // Commons
        viewCap: "View Capability",
        viewSyl: "View Syllabus",
        contactExpert: "Contact an Expert",

        // Index Page - Hero
        heroTitle: "Mastering the Marine Environment",
        heroText: "Delivering critical oceanographic data and engineering criteria for the world's most challenging offshore projects. We bridge the gap between complex marine science and operational success.",
        ourServices: "Our Services",
        contactUs: "Contact Us",

        // Index - Key Sectors
        keySectors: "Key Sectors",
        viewCapabilities: "View all capabilities",
        secEnergy: "Energy",
        secInfra: "Infrastructure",
        secDefense: "Defense",

        // Index - Sectors Cards
        offshoreWind: "Offshore Wind",
        foundCriteria: "Foundation Criteria",
        oilGas: "Oil & Gas",
        exploration: "Exploration",
        ports: "Ports",
        dredging: "Dredging",
        coastal: "Coastal",
        resilience: "Resilience",
        offshoreEnergy: "Offshore Energy",

        // Index - Tech Insights
        techInsights: "Technical Insights",
        caseStudy: "Case Study",
        caseTitle: "Optimizing installation windows for North Sea assets",
        analysis: "Analysis",
        waveAnalysis: "Extreme Wave Height Analysis",
        innovation: "Innovation",
        floatWind: "Floating Wind Challenges",

        // Index - Stats
        impactTitle: "Our Impact by the Numbers",
        impactDesc: "Decades of experience delivering precision data.",
        projCompleted: "Projects Completed",
        yearsEx: "Years of Excellence",
        countries: "Countries Served",
        experts: "PhD Experts",

        // Newsletter
        subTitle: "Subscribe to Industry Intelligence",
        subDesc: "Get the latest regulatory updates and technical best practices.",
        emailPlaceholder: "Corporate email address",
        subscribe: "Subscribe",

        // Tour
        tourWelcome: "You can find all our services and pages here.",
        tourTheme: "Switch between Dark and Light mode or Change Language here.",
        skipTour: "Skip Tour",
        stepProgress: "Step {current} of {total}",
        next: "Next",
        finish: "Finish",

        // --- SERVICES PAGE ---
        svcTitle: "Technical Services",
        svcDesc: "We provide comprehensive data analysis, modelling, and forecasting services to support every stage of your offshore project's lifecycle, from feasibility to decommissioning.",

        svcDesign: "Metocean Design Criteria",
        svcDesignDesc: "Derivation of extreme wind, wave, and current conditions for structural design.",
        svcWeather: "Weather Forecasting",
        svcWeatherDesc: "24/7 site-specific marine weather forecasting for weather-critical operations.",
        svcSurvey: "Marine Surveys",
        svcSurveyDesc: "Deployment and maintenance of oceanographic moorings, wave buoys, and ADCPs.",
        svcModel: "Numerical Modelling",
        svcModelDesc: "Advanced SWAN and hydrodynamic modelling for coastal processes.",
        svcClimate: "Climate Adaptation",
        svcClimateDesc: "Assessing the impact of sea-level rise and changing storm climatology.",
        svcTrain: "Training & Capacity",
        svcTrainDesc: "Specialized training courses for engineers and project managers.",

        svcCustomTitle: "Need a customized solution?",
        svcCustomDesc: "Our team of 50+ oceanography experts is ready to assist with your specific project challenges.",

        // --- COURSES PAGE ---
        trainTitle: "Professional Training",
        trainDesc: "Equip your team with the knowledge to manage metocean risk. Our industry-accredited courses are led by field experts.",
        courseAwareness: "Metocean Awareness Course",
        courseAwarenessDesc: "2-Day intensive course for project managers and engineers.",
        courseData: "Advanced Data Analysis",
        courseDataDesc: "MATLAB/Python workshop for handling oceanographic datasets.",
        coursePlan: "Offshore Ops Planning",
        coursePlanDesc: "Risk assessment and decision making using weather forecasts.",

        // --- ABOUT PAGE ---
        aboutTitle: "Scientific Integrity. Operational Excellence.",
        aboutDesc: "For over 25 years, Metocean has been the trusted partner for marine industries worldwide. We combine academic rigour with practical engineering experience to solve the ocean's toughest challenges.",
        labTitle: "Our Laboratory",
        leadership: "Our Leadership",

        teamF: "Dr. Mohamed Farouk",
        roleF: "Chief Executive Officer",
        descF: "Expert in marine geophysics with over 20 years of leadership in offshore consulting.",

        teamH: "Dr. Hussain Elnaggar",
        roleH: "Technical Director",
        descH: "Specialist in coastal engineering and hydrodynamic modeling for complex marine projects.",

        teamR: "Elena Rodriguez",
        roleR: "Head of Marine Operations",
        descR: "Former Master Mariner with extensive experience in North Sea logistics and safety.",

        // --- CONTACT PAGE ---
        contactTitle: "Get in Touch",
        contactDesc: "Whether you need expert consultancy or professional training, our team is ready to assist.",
        contactInfoHeading: "Contact Information",
        headquarters: "Headquarters",
        emailUs: "Email Us",
        callUs: "Call Us",
        sendMessage: "Send a Message",

        labelName: "Full Name",
        labelEmail: "Email Address",
        labelInterest: "I am interested in...",
        labelMsg: "Message",
        optionSelect: "Select an option",
        optionConsult: "Consulting Services",
        optionCourse: "Training Courses",
        optionPartner: "Partnership",
        optionOther: "Other Inquiry",
        btnSend: "Send Message",

        phName: "John Doe",
        phEmail: "john@company.com",
        phMsg: "Tell us about your project requirements..."
    },

    ar: {
        // Nav & Footer
        brand: "ميتوشيان",
        home: "الرئيسية",
        services: "خدماتنا",
        courses: "الدورات",
        about: "عن الشركة",
        contact: "اتصل بنا",
        portal: "ابدأ الآن",
        footerDesc: "رواد عالميون في الاستشارات الأوقيانوغرافية. أكثر من 25 عامًا من تمكين العمليات البحرية الآمنة من خلال الهندسة الدقيقة والبيانات.",
        quickLinks: "روابط سريعة",
        contactInfo: "معلومات الاتصال",
        rights: "© 2025 مجموعة ميتوشيان للاستشارات. جميع الحقوق محفوظة.",
        createdBy: "تصميم <a href='https://adhamamin.github.io/My-Portflio/' target='_blank' style='color: var(--primary); text-decoration: none;'>أدهم أمين</a>",
        privacy: "سياسة الخصوصية",
        address: "١٠٠ طريق المحيط، جناح ٥٠٠<br>مدينة الملاحة، ١٢٣٤٥",

        // Commons
        viewCap: "عرض القدرات",
        viewSyl: "عرض المنهج",
        contactExpert: "تحدث مع خبير",

        // Index Page - Hero
        heroTitle: "إتقان البيئة البحرية",
        heroText: "تقديم بيانات أوقيانوغرافية ومعايير هندسية دقيقة لأكثر المشاريع البحرية تحديًا في العالم. نحن نسد الفجوة بين العلوم البحرية المعقدة والنجاح التشغيلي.",
        ourServices: "خدماتنا",
        contactUs: "تواصل معنا",

        // Index - Key Sectors
        keySectors: "القطاعات الرئيسية",
        viewCapabilities: "عرض جميع القدرات",
        secEnergy: "الطاقة",
        secInfra: "البنية التحتية",
        secDefense: "الدفاع",

        // Index - Sectors Cards
        offshoreWind: "الرياح البحرية",
        foundCriteria: "معايير التأسيس",
        oilGas: "النفط والغاز",
        exploration: "التنقيب",
        ports: "الموانئ",
        dredging: "التجريف",
        coastal: "الساحلية",
        resilience: "المرونة",
        offshoreEnergy: "الطاقة البحرية",

        // Index - Tech Insights
        techInsights: "رؤى تقنية",
        caseStudy: "دراسة حالة",
        caseTitle: "تحسين نوافذ التثبيت لأصول بحر الشمال",
        analysis: "تحليل",
        waveAnalysis: "تحليل ارتفاع الأمواج",
        innovation: "ابتكار",
        floatWind: "تحديات الرياح العائمة",

        // Index - Stats
        impactTitle: "تأثيرنا بالأرقام",
        impactDesc: "عقود من الخبرة في تقديم بيانات دقيقة.",
        projCompleted: "مشروع مكتمل",
        yearsEx: "سنوات من التميز",
        countries: "دولة تم خدمتها",
        experts: "خبراء دكتوراه",

        // Newsletter
        subTitle: "اشترك في معلومات الصناعة",
        subDesc: "احصل على أحدث التحديثات التنظيمية وأفضل الممارسات التقنية.",
        emailPlaceholder: "البريد الإلكتروني للشركة",
        subscribe: "اشترك",

        // Tour
        tourWelcome: "يمكنك العثور على جميع خدماتنا وصفحاتنا هنا.",
        tourTheme: "قم بالتبديل بين الوضع الداكن والفاتح أو تغيير اللغة من هنا.",
        skipTour: "تخطي الجولة",
        stepProgress: "الخطوة {current} من {total}",
        next: "التالي",
        finish: "إنهاء",

        // --- SERVICES PAGE ---
        svcTitle: "الخدمات التقنية",
        svcDesc: "نقدم خدمات شاملة لتحليل البيانات والنمذجة والتنبؤ لدعم كل مرحلة من مراحل دورة حياة مشروعك البحري، من الجدوى إلى التفكيك.",

        svcDesign: "معايير تصميم ميتوشيان",
        svcDesignDesc: "استنتاج ظروف الرياح والأمواج والتيارات القاسية للتصميم الهيكلي.",
        svcWeather: "التنبؤ بالطقس",
        svcWeatherDesc: "تنبؤات جوية بحرية خاصة بالموقع على مدار 24/7 للعمليات الحرجة.",
        svcSurvey: "المسح البحري",
        svcSurveyDesc: "نشر وصيانة المراسي الأوقيانوغرافية وعوامات الأمواج وأجهزة ADCP.",
        svcModel: "النمذجة العددية",
        svcModelDesc: "نمذجة SWAN والديناميكا المائية المتقدمة للعمليات الساحلية.",
        svcClimate: "التكيف مع المناخ",
        svcClimateDesc: "تقييم تأثير ارتفاع مستوى سطح البحر وتغير مناخ العواصف.",
        svcTrain: "التدريب والقدرات",
        svcTrainDesc: "دورات تدريبية متخصصة للمهندسين ومديري المشاريع.",

        svcCustomTitle: "هل تحتاج إلى حل مخصص؟",
        svcCustomDesc: "فريقنا المكون من أكثر من 50 خبيرًا في علم المحيطات مستعد للمساعدة.",

        // --- COURSES PAGE ---
        trainTitle: "التدريب المهني",
        trainDesc: "زوّد فريقك بالمعرفة لإدارة مخاطر الأرصاد الجوية البحرية. دوراتنا معتمدة ويقودها خبراء في المجال.",
        courseAwareness: "دورة التوعية بميتوشيان",
        courseAwarenessDesc: "دورة مكثفة لمدة يومين لمديري المشاريع والمهندسين.",
        courseData: "تحليل البيانات المتقدم",
        courseDataDesc: "ورشة عمل MATLAB/Python للتعامل مع مجموعات البيانات الأوقيانوغرافية.",
        coursePlan: "تخطيط العمليات البحرية",
        coursePlanDesc: "تقييم المخاطر واتخاذ القرارات باستخدام التنبؤات الجوية.",

        // --- ABOUT PAGE ---
        aboutTitle: "النزاهة العلمية. التميز التشغيلي.",
        aboutDesc: "لأكثر من 25 عامًا، كانت ميتوشيان الشريك الموثوق للصناعات البحرية في جميع أنحاء العالم.",
        labTitle: "مختبرنا",
        leadership: "قيادتنا",

        teamF: "د. محمد فاروق",
        roleF: "الرئيس التنفيذي",
        descF: "خبير في الجيوفيزياء البحرية مع أكثر من 20 عامًا من القيادة.",

        teamH: "د. حسين النجار",
        roleH: "المدير الفني",
        descH: "متخصص في الهندسة الساحلية والنمذجة الهيدروديناميكية.",

        teamR: "إيلينا رودريغيز",
        roleR: "رئيس العمليات البحرية",
        descR: "قبطان بحري سابق ذو خبرة واسعة في لوجستيات بحر الشمال.",

        // --- CONTACT PAGE ---
        contactTitle: "تواصل معنا",
        contactDesc: "سواء كنت بحاجة إلى استشارات خبيرة أو تدريب مهني، فريقنا مستعد للمساعدة.",
        contactInfoHeading: "معلومات الاتصال",
        headquarters: "المقر الرئيسي",
        emailUs: "راسلنا",
        callUs: "اتصل بنا",
        sendMessage: "أرسل رسالة",

        labelName: "الاسم الكامل",
        labelEmail: "البريد الإلكتروني",
        labelInterest: "أنا مهتم بـ...",
        labelMsg: "الرسالة",
        optionSelect: "اختر خياراً",
        optionConsult: "خدمات استشارية",
        optionCourse: "دورات تدريبية",
        optionPartner: "شراكة",
        optionOther: "أخرى",
        btnSend: "أرسل الرسالة",

        phName: "الاسم",
        phEmail: "name@company.com",
        phMsg: "أخبرنا عن متطلبات مشروعك..."
    }
};

// *** CRITICAL FIX: Force English/Light Theme on First Visit ***
const isFirstVisit = !localStorage.getItem('metocean_visited');
let currentLang, currentTheme;

if (isFirstVisit) {
    // First time visitor - force defaults
    currentLang = 'en';
    currentTheme = 'light';
} else {
    // Returning visitor - use saved preferences or defaults
    currentLang = localStorage.getItem('metocean_lang') || 'en';
    currentTheme = localStorage.getItem('metocean_theme') || 'light';
}

// Apply settings on load
document.documentElement.setAttribute('lang', currentLang);
document.documentElement.setAttribute('dir', currentLang === 'ar' ? 'rtl' : 'ltr');
document.documentElement.setAttribute('data-theme', currentTheme);


// GENERATE CONTENT BASED ON LANGUAGE (Header/Footer)
function getHeaderContent() {
    const t = translations[currentLang];
    return `
<nav id="navbar-tour-target">
    <div class="container nav-wrapper">
        <a href="index.html" class="brand">${t.brand}</a>
        <ul class="nav-links">
            <li><a href="index.html" class="nav-item">${t.home}</a></li>
            <li><a href="services.html" class="nav-item">${t.services}</a></li>
            <li><a href="courses.html" class="nav-item">${t.courses}</a></li>
            <li><a href="about.html" class="nav-item">${t.about}</a></li>
            <li><a href="contact.html" class="nav-item">${t.contact}</a></li>
        </ul>
        <div class="nav-actions">
            <!-- Search Icon -->
            <span class="material-symbols-outlined icon-hover" style="cursor: pointer;">search</span>
            
            <!-- Get Started Button -->
            <a href="login.html" class="btn btn-primary btn-sm btn-animate" data-text="${t.portal}">
                <span>${t.portal}</span>
            </a>

            <!-- Mobile Menu Toggle -->
            <span class="material-symbols-outlined mobile-menu-btn" id="mobile-menu-btn">menu</span>
        </div>
    </div>
</nav>

<!-- Mobile Menu Drawer -->
<div class="mobile-menu-overlay" id="mobile-menu-overlay"></div>
<div class="mobile-menu-drawer" id="mobile-menu-drawer">
    <div class="mobile-menu-header">
        <span class="brand">${t.brand}</span>
        <span class="material-symbols-outlined close-btn" id="mobile-menu-close">close</span>
    </div>
    <ul class="mobile-nav-links">
        <li><a href="index.html">${t.home}</a></li>
        <li><a href="services.html">${t.services}</a></li>
        <li><a href="courses.html">${t.courses}</a></li>
        <li><a href="about.html">${t.about}</a></li>
        <li><a href="contact.html">${t.contact}</a></li>
    </ul>
    <div class="mobile-menu-footer">
        <a href="login.html" class="btn btn-primary w-full">${t.portal}</a>
    </div>
</div>
`;
}

function getFooterContent() {
    const t = translations[currentLang];
    const themeIcon = currentTheme === 'dark' ? 'light_mode' : 'dark_mode';

    return `
<footer>
    <div class="container">
        <div class="footer-grid">
            <div class="footer-col animate-slide-up" style="padding-right: 2rem;">
                <a href="index.html" class="brand" style="display: block; margin-bottom: 1.5rem;">${t.brand}</a>
                <p style="font-size: 0.95rem; margin-bottom: 1.5rem; line-height: 1.8; color: var(--text-muted);">
                    ${t.footerDesc}
                </p>
                <div class="social-icons">
                    <a href="#" class="social-icon" title="LinkedIn"><img src="https://cdn-icons-png.flaticon.com/512/174/174857.png" alt="LinkedIn"></a>
                    <a href="#" class="social-icon" title="Twitter"><img src="https://cdn-icons-png.flaticon.com/512/733/733579.png" alt="Twitter"></a>
                    <a href="#" class="social-icon" title="Instagram"><img src="https://cdn-icons-png.flaticon.com/512/2111/2111463.png" alt="Instagram"></a>
                </div>
            </div>
            
            <div class="footer-col animate-slide-up delay-100">
                <h4>${t.quickLinks}</h4>
                <ul>
                    <li><a href="index.html" class="nav-item">${t.home}</a></li>
                    <li><a href="about.html" class="nav-item">${t.about}</a></li>
                    <li><a href="services.html" class="nav-item">${t.services}</a></li>
                    <li><a href="courses.html" class="nav-item">${t.courses}</a></li>
                    <li><a href="contact.html" class="nav-item">${t.contact}</a></li>
                </ul>
            </div>
            
            <div class="footer-col animate-slide-up delay-200">
                <h4>${t.contactInfo}</h4>
                <ul style="color: var(--text-muted); font-size: 0.95rem;">
                    <li style="margin-bottom: 1rem;">${t.address}</li>
                    <li style="margin-bottom: 1rem;"><a href="mailto:info@metocean.com">info@metocean.com</a></li>
                    <li><a href="tel:+15551234567">+1 (555) 123-4567</a></li>
                </ul>

                <!-- Toggles with ID for Tour -->
                <div class="footer-toggles" id="footer-toggles-tour">
                    <button class="circle-btn" onclick="toggleTheme()" title="Toggle Theme">
                        <span class="material-symbols-outlined">${themeIcon}</span>
                    </button>
                    <button class="circle-btn" onclick="toggleLanguage()" title="Switch Language">
                        <span class="material-symbols-outlined">language</span>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>${t.rights}</p>
            <div class="footer-links">
                <span>${t.createdBy}</span>
                <span>${t.privacy}</span>
            </div>
        </div>
    </div>
</footer>
`;
}

document.addEventListener("DOMContentLoaded", function () {
    loadIncludes();
    initCounters();
    translatePage();

    // *** STRICT LOGIC: ONLY Home Page + ONLY First Visit ***
    const hasVisited = localStorage.getItem('metocean_visited');
    const path = window.location.pathname;
    const isHomePage = path.endsWith('index.html') || path.endsWith('/') || path === '' || path.includes('index.html');

    if (!hasVisited && isHomePage) {
        injectWelcomeModal();
        setTimeout(() => {
            const modalOverlay = document.getElementById('welcome-modal-overlay');
            if (modalOverlay) {
                modalOverlay.classList.add('active');
            }
        }, 500);
    }
    // ELSE: Do nothing. No modal will be injected.
});

function loadIncludes() {
    const headerPlaceholder = document.getElementById("header-placeholder");
    if (headerPlaceholder) {
        headerPlaceholder.innerHTML = getHeaderContent();
        highlightActiveLink();
        initMobileMenu();
    }

    const footerPlaceholder = document.getElementById("footer-placeholder");
    if (footerPlaceholder) {
        footerPlaceholder.innerHTML = getFooterContent();
    }

    // Inject scroll-to-top button if it doesn't exist
    if (!document.getElementById('scroll-to-top')) {
        const scrollBtnHTML = `
        <button class="scroll-to-top" id="scroll-to-top" onclick="scrollToTop()">
            <span class="material-symbols-outlined">arrow_upward</span>
        </button>
        `;
        document.body.insertAdjacentHTML('beforeend', scrollBtnHTML);
    }

    translatePage();
}

function toggleTheme() {
    currentTheme = currentTheme === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', currentTheme);
    localStorage.setItem('metocean_theme', currentTheme);
    loadIncludes();
}

function toggleLanguage() {
    currentLang = currentLang === 'en' ? 'ar' : 'en';
    document.documentElement.setAttribute('lang', currentLang);
    document.documentElement.setAttribute('dir', currentLang === 'ar' ? 'rtl' : 'ltr');
    localStorage.setItem('metocean_lang', currentLang);
    loadIncludes();
}

function selectLanguageInit(lang) {
    currentLang = lang;
    document.documentElement.setAttribute('lang', currentLang);
    document.documentElement.setAttribute('dir', currentLang === 'ar' ? 'rtl' : 'ltr');
    localStorage.setItem('metocean_lang', currentLang);
    localStorage.setItem('metocean_visited', 'true');
    loadIncludes();

    // Close Modal
    const modalOverlay = document.getElementById('welcome-modal-overlay');
    if (modalOverlay) {
        modalOverlay.classList.remove('active');
    }

    // Start Tour (Since language selected = first visit on home page valid case)
    setTimeout(() => {
        startTour();
    }, 1000); // Increased delay to ensure header/footer are stable
}

function skipTour() {
    // Mark as visited and close modal without starting tour
    localStorage.setItem('metocean_visited', 'true');
    const modalOverlay = document.getElementById('welcome-modal-overlay');
    if (modalOverlay) {
        modalOverlay.classList.remove('active');
    }
}

function translatePage() {
    const t = translations[currentLang];
    const elements = document.querySelectorAll('[data-i18n]');
    elements.forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) {
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                el.placeholder = t[key];
            } else {
                el.innerHTML = t[key];
            }
        }
    });
    const animatedBtns = document.querySelectorAll('.btn-animate');
    animatedBtns.forEach(btn => {
        const textSpan = btn.querySelector('span');
        if (textSpan) btn.setAttribute('data-text', textSpan.innerText);
    });
}

function highlightActiveLink() {
    const currentPath = window.location.pathname.split("/").pop() || "index.html";
    const links = document.querySelectorAll(".nav-links a, .mobile-nav-links a");
    links.forEach(link => {
        const linkPath = link.getAttribute("href");
        if (linkPath === currentPath) {
            link.classList.add("active");
            link.style.color = "var(--primary)";
        }
    });
}

function initMobileMenu() {
    const btn = document.getElementById("mobile-menu-btn");
    const closeBtn = document.getElementById("mobile-menu-close");
    const drawer = document.getElementById("mobile-menu-drawer");
    const overlay = document.getElementById("mobile-menu-overlay");

    if (btn && drawer && overlay) {
        btn.addEventListener("click", () => {
            drawer.classList.add("open");
            overlay.classList.add("open");
        });

        const closeMenu = () => {
            drawer.classList.remove("open");
            overlay.classList.remove("open");
        };

        if (closeBtn) closeBtn.addEventListener("click", closeMenu);
        overlay.addEventListener("click", closeMenu);
    }
}

function initCounters() {
    setTimeout(() => {
        const counters = document.querySelectorAll('.counter');
        if (counters.length === 0) return;
        const observerOption = { root: null, threshold: 0.5 };
        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const counter = entry.target;
                    const target = +counter.getAttribute('data-target');
                    const duration = 5000;
                    const startTime = performance.now();
                    const start = 0;
                    const updateCount = (currentTime) => {
                        const elapsedTime = currentTime - startTime;
                        const progress = Math.min(elapsedTime / duration, 1);
                        const ease = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
                        const count = Math.floor(ease * (target - start) + start);
                        counter.innerText = count + (target > 100 ? '+' : '');
                        if (progress < 1) requestAnimationFrame(updateCount);
                        else counter.innerText = target + '+';
                    };
                    requestAnimationFrame(updateCount);
                    observer.unobserve(counter);
                }
            });
        }, observerOption);
        counters.forEach(counter => observer.observe(counter));
    }, 100);
}

// --- WELCOME & TOUR LOGIC ---

function injectWelcomeModal() {
    const t = translations[currentLang];
    const modalHTML = `
    <div class="welcome-modal-overlay" id="welcome-modal-overlay">
        <div class="welcome-modal">
            <h2 class="welcome-title">Welcome to Metocean</h2>
            <p class="welcome-subtitle">Please select your preferred language</p>
            <div class="lang-selection">
                <div class="lang-card" onclick="selectLanguageInit('en')">
                    <h3>English</h3>
                    <p>Continue in English</p>
                </div>
                <div class="lang-card" onclick="selectLanguageInit('ar')">
                    <h3 style="font-family: 'Tajawal', sans-serif;">العربية</h3>
                    <p style="font-family: 'Tajawal', sans-serif;">أكمل باللغة العربية</p>
                </div>
            </div>
            <button class="skip-tour-btn" onclick="skipTour()" id="skip-tour-btn">${t.skipTour}</button>
        </div>
    </div>
    
    <!-- Tour Tooltip Placeholder -->
    <div class="tour-tooltip" id="tour-tooltip">
        <div class="tour-progress" id="tour-progress"></div>
        <h4 id="tour-title"></h4>
        <p id="tour-desc"></p>
        <div class="tour-controls">
            <button class="tour-btn" id="tour-btn-next" onclick="nextTourStep()"></button>
        </div>
    </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

let currentTourStep = 0;

function getTourSteps() {
    return [
        {
            targetId: 'navbar-tour-target',
            title: translations[currentLang].brand,
            desc: translations[currentLang].tourWelcome,
            scroll: 'top',
            placement: 'bottom'
        },
        {
            targetId: 'footer-toggles-tour',
            title: translations[currentLang].contactInfo,
            desc: translations[currentLang].tourTheme,
            scroll: 'center',
            placement: 'top' // New property
        }
    ];
}

function startTour() {
    currentTourStep = 0;
    const steps = getTourSteps();
    updateTourStep(steps[0]);
}

function nextTourStep() {
    const steps = getTourSteps();

    // Remove highlight from current
    const currentEl = document.getElementById(steps[currentTourStep].targetId);
    if (currentEl) currentEl.classList.remove('tour-active-element');

    currentTourStep++;

    if (currentTourStep >= steps.length) {
        endTour();
        return;
    }

    updateTourStep(steps[currentTourStep]);
}

function updateTourStep(step) {
    const t = translations[currentLang];
    const tooltip = document.getElementById('tour-tooltip');
    const progressEl = document.getElementById('tour-progress');
    const titleEl = document.getElementById('tour-title');
    const descEl = document.getElementById('tour-desc');
    const btnEl = document.getElementById('tour-btn-next');

    const targetEl = document.getElementById(step.targetId);
    if (!targetEl) {
        console.warn(`Tour Target not found: ${step.targetId}`);
        // If element is not found, try to skip to next or end
        if (currentTourStep < getTourSteps().length - 1) {
            nextTourStep();
        } else {
            endTour();
        }
        return;
    }

    // Scroll to target
    targetEl.scrollIntoView({ behavior: 'smooth', block: step.scroll });

    // Highlight
    targetEl.classList.add('tour-active-element');

    // Position Tooltip
    // Wait for scroll to finish/stabilize
    setTimeout(() => {
        const rect = targetEl.getBoundingClientRect();

        // Update Content FIRST to get correct height
        const totalSteps = getTourSteps().length;
        const currentStep = currentTourStep + 1;
        progressEl.innerText = t.stepProgress.replace('{current}', currentStep).replace('{total}', totalSteps);
        titleEl.innerText = step.title;
        descEl.innerText = step.desc;
        btnEl.innerText = (currentTourStep === totalSteps - 1) ? t.finish : t.next;

        // Get dimensions
        const tooltipHeight = tooltip.offsetHeight || 150; // Fallback if hidden
        // Helper to get actual height if completely hidden might be tricky, 
        // but 'visibility: hidden' elements usually have dimensions if 'display' is not 'none'.
        // The CSS has 'visibility: hidden', so offsetHeight works.

        // Simple positioning logic
        let top, left;

        // Horizontal centering (default)
        left = rect.left + (rect.width / 2) - 150; // 150 is half of 300px width

        if (step.placement === 'top') {
            top = rect.top - tooltipHeight - 60; // Increased offset for better spacing
        } else {
            // Default bottom
            top = rect.bottom + 20;
        }

        // Screen Edge Adjustments
        if (left < 20) left = 20;
        if (left + 300 > window.innerWidth) left = window.innerWidth - 320;

        // Vertical safeguards
        if (top < 10) top = rect.bottom + 20; // Flip to bottom if no space on top
        if (top + tooltipHeight > window.innerHeight) top = rect.top - tooltipHeight - 60; // Flip to top if no space bottom

        tooltip.style.top = top + 'px';
        tooltip.style.left = left + 'px';
        tooltip.classList.add('active');

    }, 600);
}

function endTour() {
    const tooltip = document.getElementById('tour-tooltip');
    if (tooltip) {
        tooltip.classList.remove('active');
    }

    // Cleanup highlights
    const highlights = document.querySelectorAll('.tour-active-element');
    highlights.forEach(el => el.classList.remove('tour-active-element'));
}

// --- SCROLL TO TOP FUNCTIONALITY ---
function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

// Show/hide scroll-to-top button based on scroll position
window.addEventListener('scroll', function () {
    const scrollBtn = document.getElementById('scroll-to-top');
    if (scrollBtn) {
        if (window.pageYOffset > 300) {
            scrollBtn.classList.add('visible');
        } else {
            scrollBtn.classList.remove('visible');
        }
    }
});

// --- SEARCH FUNCTIONALITY ---
function initSearch() {
    const searchIcon = document.querySelector('.icon-hover');
    if (!searchIcon) return;

    searchIcon.addEventListener('click', function () {
        showSearchOverlay();
    });
}

function showSearchOverlay() {
    // Create search overlay if it doesn't exist
    if (!document.getElementById('search-overlay')) {
        const searchHTML = `
        <div class="search-overlay" id="search-overlay">
            <div class="search-container">
                <div class="search-header">
                    <input type="text" class="search-input" id="search-input" placeholder="Search..." autofocus>
                    <span class="material-symbols-outlined search-close" onclick="closeSearch()">close</span>
                </div>
                <div class="search-results" id="search-results">
                    <p class="search-hint">Type to search...</p>
                </div>
            </div>
        </div>
        `;
        document.body.insertAdjacentHTML('beforeend', searchHTML);

        // Add event listeners
        const searchInput = document.getElementById('search-input');
        searchInput.addEventListener('input', performSearch);

        // Close on ESC
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') closeSearch();
        });
    }

    document.getElementById('search-overlay').classList.add('active');
    setTimeout(() => {
        document.getElementById('search-input').focus();
    }, 100);
}

function closeSearch() {
    const overlay = document.getElementById('search-overlay');
    if (overlay) {
        overlay.classList.remove('active');
        document.getElementById('search-input').value = '';
        document.getElementById('search-results').innerHTML = '<p class="search-hint">Type to search...</p>';
    }
}

function performSearch() {
    const query = document.getElementById('search-input').value.toLowerCase();
    const resultsContainer = document.getElementById('search-results');

    if (query.length < 2) {
        resultsContainer.innerHTML = '<p class="search-hint">Type at least 2 characters...</p>';
        return;
    }

    // Simple search through page content
    const searchableContent = [
        { title: 'Home', url: 'index.html', keywords: 'metocean marine environment oceanographic offshore' },
        { title: 'Services', url: 'services.html', keywords: 'design criteria forecasting surveys modelling climate training' },
        { title: 'Courses', url: 'courses.html', keywords: 'training professional awareness data analysis planning' },
        { title: 'About', url: 'about.html', keywords: 'company team leadership laboratory expertise' },
        { title: 'Contact', url: 'contact.html', keywords: 'get in touch email phone headquarters' },
        { title: 'Offshore Wind', url: 'services.html', keywords: 'wind energy foundation renewable' },
        { title: 'Oil & Gas', url: 'services.html', keywords: 'exploration drilling petroleum' },
        { title: 'Coastal Resilience', url: 'services.html', keywords: 'coastal protection climate adaptation' }
    ];

    const results = searchableContent.filter(item =>
        item.title.toLowerCase().includes(query) ||
        item.keywords.toLowerCase().includes(query)
    );

    if (results.length === 0) {
        resultsContainer.innerHTML = '<p class="search-no-results">No results found</p>';
    } else {
        resultsContainer.innerHTML = results.map(item => `
            <a href="${item.url}" class="search-result-item">
                <span class="material-symbols-outlined">search</span>
                <span>${item.title}</span>
            </a>
        `).join('');
    }
}

// Initialize search when DOM is loaded
document.addEventListener('DOMContentLoaded', function () {
    setTimeout(initSearch, 500);
});

